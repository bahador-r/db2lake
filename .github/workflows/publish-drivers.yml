name: Publish db2lake drivers

on:
  push:
    branches: [ master ]
    paths:
      - 'packages/driver-**/**'
      - 'package.json'
  workflow_dispatch:
    inputs: {}

jobs:
  publish-drivers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm auth
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc

      - name: Install workspace deps
        run: npm ci

      - name: Build repository (project references)
        run: npm run build

      - name: Find changed driver packages
        id: changed
        run: |
          echo "packages=$(git diff --name-only HEAD^ HEAD | grep '^packages/driver-' | awk -F/ '{print $2}' | sort -u | paste -sd, -)" >> $GITHUB_OUTPUT || true

      - name: Build & publish changed drivers
        if: steps.changed.outputs.packages != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          IFS=',' read -ra pkgs <<< "${{ steps.changed.outputs.packages }}"
          for p in "${pkgs[@]}"; do
            echo "Publishing $p"
            npm run build --workspace=@db2lake/$p
            (cd packages/$p && npm publish --access public)
          done
